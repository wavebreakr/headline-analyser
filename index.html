// CORE FUNCTION: RUN SIMPLIFICATION (Now focused on NLP)
function runSimplify() {
    const inputTextarea = document.getElementById('inputText');
    const inputText = inputTextarea.value;
    const outputTextarea = document.getElementById('outputText');
    outputTextarea.value = ""; 

    if (!inputText.trim().length) {
        updateStats("", "");
        return;
    }

    updateStats(inputText, ""); 
    
    // --- 1. Initial Processing and Splitting ---
    let processedText = inputText;
    
    // 1a. Essential Jargon Replacement (Simple Regex Pass - MUST RUN FIRST)
    processedText = applyReplacements(processedText, essentialWordMap);

    // 1b. Split the text into an array of sentences for individual NLP processing
    const sentences = nlp(processedText).sentences().out('array');
    
    let finalSimplifiedText = [];

    // --- 2. COMPROMISE.JS PASS (Sentence by Sentence) ---
    try {
        sentences.forEach(sentence => {
            let doc = nlp(sentence); // Initialize the library with ONE clean sentence

            // Simplification Command 1: Expand contractions (e.g., isn't -> is not)
            doc = doc.contractions().expand(); 
            
            // Simplification Command 2: Change passive verbs to active where possible
            doc = doc.verbs().toActive();
            
            // Simplification Command 3: Remove all adverbs that weaken a phrase 
            doc.match('(most|very|highly) [adjective]').delete();

            let simplifiedSentence = doc.text();
            
            // 3. Final cleaning and capitalization pass (on the single sentence)
            simplifiedSentence = cleanAndCapitalize(simplifiedSentence); 

            finalSimplifiedText.push(simplifiedSentence);
        });
        
    } catch (e) {
        // If the library fails, fall back to the raw text to prevent crashing.
        console.error("Compromise.js error during iteration:", e);
        finalSimplifiedText = [processedText]; // Fallback to raw text
    }
    // --- END COMPROMISE.JS PASS ---


    const outputText = finalSimplifiedText.join(' '); // Join sentences with a space
    outputTextarea.value = outputText;
    updateStats(inputText, outputText); 
}
